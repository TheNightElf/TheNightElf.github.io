---
title: 拖拽功能
date: 2017-06-08 10:06:56
tags:
---

`HTML5` 为我们提供了 `drag/drop` 拖拽功能的 `api`，极大的简化了我们在开发拖拽功能时的代码量。
<!-- more -->

### API介绍
所有的拖拽事件必须作用于可拖拽的元素上(`draggable='true'`)，否则将无法触发拖拽事件。

**drag**
作用于：拖拽元素。
说明：当元素或者选择的文本被拖动时触发 `drag` 事件 (频率：每几百毫秒触发一次)。

**dragstart**
作用于：拖拽元素。
说明：当用户开始拖动一个元素或者一个选择文本的时候 `dragstart` 事件就会触发(仅触发一次)。

**dragover**
作用于：目标元素。
说明：当元素或者选择的文本被拖拽到一个有效的放置目标上时，触发 `dragover` 事件(频率：每几百毫秒触发一次)。

**dragenter**
作用于：目标元素。
说明：当元素或者选择的文本被拖拽进入到一个有效的放置目标上时，触发 `dragenter` 事件(仅触发一次)。

**dragleave**
作用于：目标元素。
说明：当元素或者选择的文本被拖拽离开一个有效的放置目标上时，触发 `dragleave` 事件(仅触发一次)。

**dragend**
作用于：拖拽元素。
说明：当一个拖拽的操作被取消(弹起鼠标/按下 `space` 键)时，触发 `dragend` 事件(仅触发一次)。

**drop**
作用于：目标元素。
说明：当一个元素或是选中的文字被拖拽释放到一个 `有效的` 释放目标位置时，`drop` 事件被抛出(仅触发一次)。

```html
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Document</title>

    <style lang="">
        .drag-box {
            width: 100px;
            height: 100px;
            background-color: lightcoral;
        }

        .drop-box {
            width: 500px;
            height: 500px;
            background-color: lightblue;
        }
    </style>
</head>
<body>
    <div class="drag-box" id="drag-box" draggable="true"></div>

    <div class="drop-box"></div>

    <script>
        var el = document.getElementById('drag-box'),
            tar = document.getElementById('drog-box');

        // 元素触发拖拽
        el.ondrag = function (e) {
            // ...
        }

        // 开始拖拽
        el.ondragstart = function (e) {
            // ...
        }

        // 拖拽结束
        el.ondragend = function (e) {
            // ...
        }

        // 拖拽至目标元素上
        tar.ondragover = function (e) {
            e.preventDefault();

            // ...
        }

        // 拖拽进入目标元素
        tar.ondragenter = function (e) {
            // ...
        }

        // 拖拽离开目标元素
        tar.ondragleave = function (e) {
            // ...
        }
        

        // 拖拽释放
        tar.ondrop = function (e) {
            // ...
        }


    </script>
</body>
</html>
```


### 传递消息

在拖拽的整个周期中，我们都可以通过 `dataTransfer` 来传递数据。但是数据流通必须在 `dropEffect` 与 `effectAllowed` 值相同的情况下才能进行传输。

```js
// 在开始拖拽的时候设置数据
el.ondragstart = function (e) {
    // 设置 effectAllowed 为 'move'
    e.dataTransfer.effectAllowed = 'move';
    e.dataTransfer.setData('msg', JSON.stringify({name: 'Carl'}))
}

// 在拖拽结束的时候清除数据
el.ondragend = function (e) {
    e.dataTransfer.clearData('msg')
}

// 再拖拽释放的时候获取数据
tar.ondrop = function (e) {
    // 必须设置 dropEffect 为 'move'，否则无法通过 getData 获取数据
    e.dataTransfer.dropEffect = 'move';
    let msg = JSON.parse(e.dataTransfer.getData('msg'));
    console.log(msg.name); // -> 'Carl'
}

```

### 常见的 `dropEffect` 与 `effectAllowed` 值
**常见的 `dropEffect` 的值**

* copy：复制到新的位置
* move：移动到新的位置
* link: 建立一个源位置到新位置的链接
* none：禁止任何操作

**常见的 `effectAllowed` 值**

* copy: 复制到新的位置
* move:移动到新的位置
* link:建立一个源位置到新位置的链接
* copyLink: 允许复制或者链接
* copyMove: 允许复制或者移动
* linkMove: 允许链接或者移动
* all: 允许所有的操作
* none: 禁止所有操作
* uninitialized: 缺省值(默认值), 相当于 `all`

细心的你可能会发现 `dropEffect` 与 `effectAllowed` 的值类型上根本不匹配，那么我上面说的 **`dropEffect` 与 `effectAllowed` 值相同的情况下才能进行传输** 岂不是根本就对应不上了？
文档上对此的解释是：`dropEffect` 与 `effectAllowed` 的值，**分配任何其他值时不会有任何影响并且保留旧值**。意思就是多次的修改 `dropEffect` 与 `effectAllowed` 的值并不会影响之前设置的值，类似于 `addEventListener` 的用法(关于这点我并没有具体的实验过，感兴趣的可以自己试下)，[文档地址](https://developer.mozilla.org/zh-CN/docs/Web/API/DataTransfer)。

### 总结

说的再多可能都没有自己写一个 `demo` 理解的快，关于 `drag/drop` 常用的一些东西已经在上面列出了。`dropEffect` 对象中还有一些别的方法，不过引用情况并不是特别多，所以这里就不再一一讲解了，感兴趣的可以看下[文档](https://developer.mozilla.org/zh-CN/docs/Web/API/DataTransfer)。
